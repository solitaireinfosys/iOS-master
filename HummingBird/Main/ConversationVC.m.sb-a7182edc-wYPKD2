//
//  ConversationVC.m
//  HummingBird
//
//  Created by Star on 12/5/15.
//  Copyright Â© 2015 Star. All rights reserved.
//
#import <UIKit/UIKit.h>
#import "ConversationVC.h"
#import "AppDelegate.h"
#import "Common.h"
#import "SVProgressHUD.h"
#import "AFNetworking.h"
#import "Message.h"
#import "questionModel.h"
#import "userModel.h"
#import "CommunityVC.h"
#import "SOPlaceholderedTextView.h"
#import "RatingVC.h"
#import "Utility.h"
#import "SettingVC.h"

#import <FBSDKShareKit/FBSDKShareKit.h>
#import <FBSDKMessengerShareKit/FBSDKMessengerShareKit.h>
#import <FBSDKCoreKit/FBSDKCoreKit.h>
#import <Social/Social.h>
#import <Foundation/Foundation.h>

#import "CustomIOS7AlertView.h"

#import <AVFoundation/AVFoundation.h>

#ifdef humming_dist
#import "Analytics.h"
#endif

#define rating_show 0
#define rating_hide -210

#import "ISSpeechRecognition.h"

static NSString *kBaseDateFormat = @"yyyy-MM-dd HH:mm:ss";

@interface ConversationVC ()

@property (strong, nonatomic) NSMutableArray *dataSource;

@property (strong, nonatomic) UIImage *myImage;
@property (strong, nonatomic) UIImage *partnerImage;

@end

@implementation ConversationVC


- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    
//    [self testRequest];
    shareView.hidden = NO;
    [swtShare setThumbTintColor:[UIColor colorWithPatternImage:[UIImage imageNamed:@"login_fb"]]];
    
    if ([[NSUserDefaults standardUserDefaults] integerForKey:@"FBShareFlag"] == 1) {
        [swtShare setOn:true];
    }else{

        [swtShare setOn:false];
    }
    
    [self.view bringSubviewToFront:ratingView];
    rating_y.constant = rating_hide;
    
    btnSubmit.clipsToBounds = YES;
    btnSubmit.layer.cornerRadius = 5;
    
    
    [self onUpdateStarUI];
    
    
    
    self.dataSource = [NSMutableArray array];
    
//    self.myImage      = [UIImage imageNamed:@"userPhoto"];
//    self.partnerImage = [UIImage imageNamed:@"arturdev.jpg"];
    
//    self.navigationItem.title = theAppDelegate.gUserData.user_email;
    
    UIButton *btnCommunity = [[UIButton alloc]initWithFrame:CGRectMake(0, 0, 40, 40)];
    [btnCommunity setImage:[UIImage imageNamed:@"Community"] forState:UIControlStateNormal];
    [btnCommunity addTarget:self action:@selector(onCommunity:) forControlEvents:UIControlEventTouchUpInside];
    
    UIBarButtonItem *barCommunity = [[UIBarButtonItem alloc]initWithCustomView:btnCommunity];
    
    self.navigationItem.rightBarButtonItem = barCommunity;
    
    UIButton *btnSetting = [[UIButton alloc]initWithFrame:CGRectMake(0, 0, 44, 44)];
    [btnSetting setImage:[UIImage imageNamed:@"Settings"] forState:UIControlStateNormal];
    [btnSetting addTarget:self action:@selector(onSetting:) forControlEvents:UIControlEventTouchUpInside];
    
    
    UIBarButtonItem *barSetting = [[UIBarButtonItem alloc]initWithCustomView:btnSetting];
    
    self.navigationItem.leftBarButtonItem = barSetting;
    
    [self.btnArrow addTarget:self action:@selector(onShowRate:) forControlEvents:UIControlEventTouchUpInside];
    
    [self.btnInfo addTarget:self action:@selector(onInfo:) forControlEvents:UIControlEventTouchUpInside];
    
    self.messageInputView.textView.placeholderText = NSLocalizedString(@"What is your question...", nil);
    
    [self.messageInputView.mediaButton addTarget:self action:@selector(recognize:) forControlEvents:UIControlEventTouchUpInside];
    
    [self.btnBird addTarget:self action:@selector(onBird:) forControlEvents:UIControlEventTouchUpInside];
    
    if ([[NSUserDefaults standardUserDefaults] integerForKey:@"VoiceFlag"] == 1) {
    
        [self.imgBrand setImage:[UIImage imageNamed:@"bird_green"]];
        
    }else{
        
        [self.imgBrand setImage:[UIImage imageNamed:@"splash_icon"]];
    }
}

-(void)voiceChangeRequest:(int)nType{//1:voice on 0:voice off
    [SVProgressHUD showWithStatus:@"Sending..."];
    
    NSString *urlString = [NSString stringWithFormat:@"%@%@",WEBSERVICE_URL,[NSString stringWithFormat:WEB_VOICE_CHANGE]];
    
    AFHTTPRequestOperationManager *manager = [AFHTTPRequestOperationManager manager];
    
    NSDictionary *paramterDic = @{@"user_id":theAppDelegate.gUserData.user_id,
                                  @"voice_flag":[NSNumber numberWithInt:nType]};
    
    manager.requestSerializer = [AFHTTPRequestSerializer new];
    manager.securityPolicy.allowInvalidCertificates = YES;
    
    [manager POST:urlString parameters:paramterDic success:^(AFHTTPRequestOperation *operation, id responseObject) {
        
        [SVProgressHUD dismiss];
        
        if ( [responseObject count] > 0 ) {
            
            _mMessageData = nil;
            
            NSDictionary *responseDic = [responseObject objectAtIndex:0];
            
            if ([responseDic objectForKey:@"filter_violation"] != nil) {
                
            }
            
        }else{
            [SVProgressHUD showErrorWithStatus:WEB_FAILED];
        }
        
    } failure:^(AFHTTPRequestOperation *operation, NSError *error) {
        
        NSLog(@"%@",operation.responseString);
        [SVProgressHUD showErrorWithStatus:WEB_FAILED];
    }];
}
-(IBAction)onBird:(id)sender{
    
    if ([[NSUserDefaults standardUserDefaults] integerForKey:@"VoiceFlag"] == 1) {
        
        [[NSUserDefaults standardUserDefaults] setInteger:0 forKey:@"VoiceFlag"];
    
        [SVProgressHUD showSuccessWithStatus:@"Voice Off"];
        
        
        [self.imgBrand setImage:[UIImage imageNamed:@"splash_icon"]];
        
    }else{
        [[NSUserDefaults standardUserDefaults] setInteger:1 forKey:@"VoiceFlag"];
        
        
        [SVProgressHUD showSuccessWithStatus:@"Voice On"];
        
        
        [self.imgBrand setImage:[UIImage imageNamed:@"bird_green"]];
        
    }
    
    [[NSUserDefaults standardUserDefaults] synchronize];
    
}
-(IBAction)onHideRate:(id)sender{
    [UIView animateWithDuration:0.4
                          delay:0
                        options:(UIViewAnimationOptionAllowUserInteraction|
                                 UIViewAnimationOptionBeginFromCurrentState)
                     animations:^(void) {
                         rating_y.constant = rating_hide;
                         [self.view layoutIfNeeded];
                     }
                     completion:^(BOOL finished) {
                         self.tableView.userInteractionEnabled = YES;
                     }];
}

-(IBAction)onShowRate:(id)sender{
    
    btnStar1.tag = 0;
    btnStar2.tag = 0;
    btnStar3.tag = 0;
    btnStar4.tag = 0;
    btnStar5.tag = 0;
    
    [self onUpdateStarUI];
    
    if([self onCheckRatingPage]){
        
        [btnSubmit setBackgroundColor:[UIColor colorWithRed:127/255.0 green:127/255.0 blue:127/255.0 alpha:1.0]];
        
        [lblTopAnswer setText:_mSelectedRatingAnswerMessage.text];
        
    }else{
        
        [btnSubmit setBackgroundColor:[UIColor lightGrayColor]];
        
        [lblTopAnswer setText:@"No answer to rate"];
    }
    
    if ([[NSUserDefaults standardUserDefaults] integerForKey:@"FBShareFlag"] == 1) {
        [swtShare setOn:true];
    }else{
        
        [swtShare setOn:false];
    }
    
    [UIView animateWithDuration:0.4
                          delay:0
                        options:(UIViewAnimationOptionAllowUserInteraction|
                                 UIViewAnimationOptionBeginFromCurrentState)
                     animations:^(void) {
                         rating_y.constant = rating_show;
                         [self.view layoutIfNeeded];
                     }
                     completion:^(BOOL finished) {
                         
                         self.tableView.userInteractionEnabled = NO;
                         ratingView.userInteractionEnabled = YES;
                     }];
}
-(void)viewWillAppear:(BOOL)animated{
    [super viewDidAppear:animated];
    
    if (self.refreshTimer) {
        [self.refreshTimer invalidate];
        
        self.refreshTimer = nil;
    }
    
    self.refreshTimer = [NSTimer scheduledTimerWithTimeInterval:60 target:self selector:@selector(loadMessages1) userInfo:nil repeats:YES];
    
    
#ifdef humming_dist
    id<GAITracker> tracker = [[GAI sharedInstance] trackerWithTrackingId:kTrackingId];
    
    [tracker set:kGAIScreenName value:@"User Page"];
    [tracker send:[[[GAIDictionaryBuilder createScreenView]
                    set:@"User Page"
                    forKey:[GAIFields customDimensionForIndex:1]] build]];
#endif
    
    [[NSNotificationCenter defaultCenter] addObserver:self
                                             selector:@selector(pushReceived:)
                                                 name:kNotificationDidReceiveRemoteMessageNotification
                                               object:nil];
    
    
    [[NSNotificationCenter defaultCenter] addObserver:self
                                             selector:@selector(activeApp)
                                                 name:kNotificationDidActiveAppNotification
                                               object:nil];
    
    [self loadMessages];
}

-(void)viewWillDisappear:(BOOL)animated{
    [super viewWillDisappear:animated];
    
    
    if (self.refreshTimer) {
        [self.refreshTimer invalidate];
        
        self.refreshTimer = nil;
    }
    
    [[NSNotificationCenter defaultCenter] removeObserver:self name:kNotificationDidReceiveRemoteMessageNotification object:nil];
    
    
    [[NSNotificationCenter defaultCenter] removeObserver:self
                                                 name:kNotificationDidActiveAppNotification
                                               object:nil];
}
- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

- (void)loadMessages
{
    if (self.dataSource.count == 0) {
        [SVProgressHUD showWithStatus:REQUEST_WAITING];
    }

    NSString *urlString = [NSString stringWithFormat:@"%@%@",WEBSERVICE_URL,[NSString stringWithFormat:WEB_QUESTION_GET]];
    
    AFHTTPRequestOperationManager *manager = [AFHTTPRequestOperationManager manager];
    
    NSDictionary *paramterDic = @{@"user_id":theAppDelegate.gUserData.user_id};
    
    [manager GET:urlString parameters:paramterDic success:^(AFHTTPRequestOperation *operation, id responseObject) {
        
        
        if ( [responseObject count] > 0 ) {
            
            [SVProgressHUD dismiss];
            
            [self.dataSource removeAllObjects];
            
            NSDictionary *responseDic = [responseObject objectAtIndex:0];
            if ([[responseDic objectForKey:@"status"] intValue] == 200) {
                
                NSDateFormatter *formatter = [[NSDateFormatter alloc] init];
                
                formatter.dateFormat = kBaseDateFormat;
                
                for (int i=0; i<[responseObject count]; i++) {
                    
                    NSDictionary *objDic = [responseObject objectAtIndex:i];
                    
                    Message *chatData = [[Message alloc]init];
                    
                    if ([objDic objectForKey:@"question_id"] != nil) {
                        chatData.msg_id = [[objDic objectForKey:@"question_id"] intValue];
                    }
                    
                    if ([objDic objectForKey:@"question_text"] != nil) {
                        chatData.text = [objDic objectForKey:@"question_text"];
                    }
                    
                    if ([objDic objectForKey:@"question_date"] != nil) {
                        chatData.date = [formatter dateFromString:[objDic objectForKey:@"question_date"]];
                    }
                    
                    if ([objDic objectForKey:@"user_id"] != nil) {
                        chatData.msg_user_id = [objDic objectForKey:@"user_id"];
                    }
                    
                    if ([objDic objectForKey:@"question_active"] != nil) {
                        chatData.msg_active = [[objDic objectForKey:@"question_active"] intValue];
                    }
                    chatData.type = SOMessageTypeText;

                    
                    if ([objDic objectForKey:@"question_type"] != nil) {
                        
                        int nType = [[objDic objectForKey:@"question_type"] intValue];
                        if (nType == 1) {
                            chatData.fromMe = YES;
                        }else{
                            chatData.fromMe = NO;
                        }
                    }else{
                        chatData.fromMe = NO;
                    }
                    

                    [self.dataSource addObject:chatData];
                }
                
                
                dispatch_async(dispatch_get_main_queue(), ^{
                    [self refreshMessages];
                });
            }else{
//                [SVProgressHUD showErrorWithStatus:WEB_FAILED];
            }
            
        }else{
            [SVProgressHUD showErrorWithStatus:WEB_FAILED];
        }
        
    } failure:^(AFHTTPRequestOperation *operation, NSError *error) {
        
        NSLog(@"%@",operation.responseString);
        [SVProgressHUD showErrorWithStatus:WEB_FAILED];
        
    }];
}
- (void)loadMessages1
{
    
    NSString *urlString = [NSString stringWithFormat:@"%@%@",WEBSERVICE_URL,[NSString stringWithFormat:WEB_QUESTION_GET]];
    
    AFHTTPRequestOperationManager *manager = [AFHTTPRequestOperationManager manager];
    
    NSDictionary *paramterDic = @{@"user_id":theAppDelegate.gUserData.user_id};
    
    [manager GET:urlString parameters:paramterDic success:^(AFHTTPRequestOperation *operation, id responseObject) {
        
        if ( [responseObject count] > 0 ) {
            
            [self.dataSource removeAllObjects];
            
            NSDictionary *responseDic = [responseObject objectAtIndex:0];
            if ([[responseDic objectForKey:@"status"] intValue] == 200) {
                
                NSDateFormatter *formatter = [[NSDateFormatter alloc] init];
                
                formatter.dateFormat = kBaseDateFormat;
                
                for (int i=0; i<[responseObject count]; i++) {
                    
                    NSDictionary *objDic = [responseObject objectAtIndex:i];
                    
                    Message *chatData = [[Message alloc]init];
                    
                    if ([objDic objectForKey:@"question_id"] != nil) {
                        chatData.msg_id = [[objDic objectForKey:@"question_id"] intValue];
                    }
                    
                    if ([objDic objectForKey:@"question_text"] != nil) {
                        chatData.text = [objDic objectForKey:@"question_text"];
                    }
                    
                    if ([objDic objectForKey:@"question_date"] != nil) {
                        chatData.date = [formatter dateFromString:[objDic objectForKey:@"question_date"]];
                    }
                    
                    if ([objDic objectForKey:@"user_id"] != nil) {
                        chatData.msg_user_id = [objDic objectForKey:@"user_id"];
                    }
                    
                    if ([objDic objectForKey:@"question_active"] != nil) {
                        chatData.msg_active = [[objDic objectForKey:@"question_active"] intValue];
                    }
                    chatData.type = SOMessageTypeText;
                    
                    
                    if ([objDic objectForKey:@"question_type"] != nil) {
                        
                        int nType = [[objDic objectForKey:@"question_type"] intValue];
                        if (nType == 1) {
                            chatData.fromMe = YES;
                        }else{
                            chatData.fromMe = NO;
                        }
                    }else{
                        chatData.fromMe = NO;
                    }
                    
                    
                    [self.dataSource addObject:chatData];
                }
                
                
                dispatch_async(dispatch_get_main_queue(), ^{
                    [self refreshMessages];
                });
            }else{
                //                [SVProgressHUD showErrorWithStatus:WEB_FAILED];
            }
            
        }else{
            [SVProgressHUD showErrorWithStatus:WEB_FAILED];
        }
        
    } failure:^(AFHTTPRequestOperation *operation, NSError *error) {
        
        NSLog(@"%@",operation.responseString);
        
        
    }];
    
}
#pragma mark - SOMessaging data source
- (NSMutableArray *)messages
{
    return self.dataSource;
}

- (NSTimeInterval)intervalForMessagesGrouping
{
    // Return 0 for disableing grouping
    return 2 * 24 * 3600;
}

- (void)configureMessageCell:(SOMessageCell *)cell forMessageAtIndex:(NSInteger)index
{
    Message *message = self.dataSource[index];
    
    // Adjusting content for 3pt. (In this demo the width of bubble's tail is 3pt)
    if (!message.fromMe) {
        cell.contentInsets = UIEdgeInsetsMake(0, 3.0f, 0, 0); //Move content for 3 pt. to right
        cell.textView.textColor = [UIColor blackColor];
    } else {
        cell.contentInsets = UIEdgeInsetsMake(0, 0, 0, 3.0f); //Move content for 3 pt. to left
        cell.textView.textColor = [UIColor whiteColor];
    }
    
    cell.userImageView.layer.cornerRadius = self.userImageSize.width/2;
    
    // Fix user image position on top or bottom.
    cell.userImageView.autoresizingMask = message.fromMe ? UIViewAutoresizingFlexibleTopMargin : UIViewAutoresizingFlexibleBottomMargin;
    
    // Setting user images
    cell.userImage = message.fromMe ? self.myImage : self.partnerImage;
    
    cell.btnPlay.tag = index;
    [cell.btnPlay addTarget:self action:@selector(onMessagePlay:) forControlEvents:UIControlEventTouchUpInside];
    
}

-(IBAction)onMessagePlay:(id)sender{
    
    UIButton *btn = (UIButton*)sender;
    Message *message = self.dataSource[btn.tag];
    
    if ([[NSUserDefaults standardUserDefaults] integerForKey:@"VoiceFlag"] == 1) {
    
        AVSpeechUtterance *utterance = [AVSpeechUtterance speechUtteranceWithString:[NSString stringWithFormat:@"%@",message.text]];
        
        utterance.rate = [[NSUserDefaults standardUserDefaults] floatForKey:@"voice_rate"];
        
        NSString*lang = @"en-US";
        utterance.voice = [AVSpeechSynthesisVoice voiceWithLanguage:lang];
        
        [theAppDelegate.synth speakUtterance:utterance];
    }
    

}

- (CGFloat)messageMaxWidth
{
    return 140;
}

- (CGSize)userImageSize
{
    return CGSizeMake(40, 40);
}

- (CGFloat)messageMinHeight
{
    return 0;
}

#pragma mark - SOMessaging delegate
- (void)didSelectMedia:(NSData *)media inMessageCell:(SOMessageCell *)cell
{
    // Show selected media in fullscreen
    [super didSelectMedia:media inMessageCell:cell];
}

- (void)messageInputView:(SOMessageInputView *)inputView didSendMessage:(NSString *)message
{
    if (![[message stringByTrimmingCharactersInSet:[NSCharacterSet whitespaceAndNewlineCharacterSet]] length]) {
        return;
    }
    
    if ([[message lowercaseString]rangeOfString:@"where"].location != NSNotFound && (theAppDelegate.uLat == 0 && theAppDelegate.uLong == 0)) {
    
        [SVProgressHUD showInfoWithStatus:@"Application would like to use your current location to help question"];
        
        [theAppDelegate getLocation];
        
        return;
    }
    
    Message *msg = [[Message alloc] init];
    msg.text = message;
    msg.fromMe = YES;
    
    [inputView.textView resignFirstResponder];
    
    _mMessageData = msg;
    
    if([self onCheckRatingPage]){
        
        [lblTopAnswer setText:_mSelectedRatingAnswerMessage.text];
        
        [UIView animateWithDuration:0.4
                              delay:0
                            options:(UIViewAnimationOptionAllowUserInteraction|
                                     UIViewAnimationOptionBeginFromCurrentState)
                         animations:^(void) {
                             rating_y.constant = rating_show;
                             [self.view layoutIfNeeded];
                         }
                         completion:^(BOOL finished) {
                             
                             self.tableView.userInteractionEnabled = NO;
                             ratingView.userInteractionEnabled = YES;
                         }];
        
    }else{
        [self onRating:msg];
    }
    
}

-(BOOL)onCheckRatingPage{
    
    BOOL flag = false;
    
    if (self.dataSource.count > 1) {
        
        _mSelectedRatingQuestionMessage = [self.dataSource objectAtIndex:self.dataSource.count-2];
        
        _mSelectedRatingAnswerMessage = [self.dataSource objectAtIndex:self.dataSource.count-1];
        
        if (_mSelectedRatingAnswerMessage.fromMe == YES || _mSelectedRatingAnswerMessage.msg_active == 0) {
            flag = false;
        }else{
        
            if (_mSelectedRatingAnswerMessage.msg_id == theAppDelegate.gUserData.user_last_rating_qID) {
                
                flag = false;
            }else{
                flag = true;
            }
        }
        
    }
    
    return flag;
    
}

-(void)onRating:(Message*)msg{
    
    [self onRequestSend:msg];
    
    btnStar1.tag = 0;
    btnStar2.tag = 0;
    btnStar3.tag = 0;
    btnStar4.tag = 0;
    btnStar5.tag = 0;
    
    [self onUpdateStarUI];
}

-(void)onRequestSend:(Message*)msg{
    
    [SVProgressHUD showWithStatus:@"Sending..."];
    
    NSString *urlString = [NSString stringWithFormat:@"%@%@",WEBSERVICE_URL,[NSString stringWithFormat:WEB_QUESTION_POST]];
    
    AFHTTPRequestOperationManager *manager = [AFHTTPRequestOperationManager manager];
    
    NSDictionary *paramterDic = @{@"user_id":theAppDelegate.gUserData.user_id,
                                  @"question":msg.text,
                                  @"question_lat":[NSString stringWithFormat:@"%f",theAppDelegate.uLat],
                                  @"question_long":[NSString stringWithFormat:@"%f",theAppDelegate.uLong]};
    manager.requestSerializer = [AFHTTPRequestSerializer new];
    manager.securityPolicy.allowInvalidCertificates = YES;
    
    [manager POST:urlString parameters:paramterDic success:^(AFHTTPRequestOperation *operation, id responseObject) {
        
        [SVProgressHUD dismiss];
        
        if ( [responseObject count] > 0 ) {
            
            _mMessageData = nil;
            
            NSDictionary *responseDic = [responseObject objectAtIndex:0];
            
            if ([responseDic objectForKey:@"filter_violation"] != nil) {
//                int filter_violation = [[responseDic objectForKey:@"filter_violation"] intValue];
                
//                if (filter_violation != 1) {
//                    
//                    UIAlertController *_alertView = [UIAlertController alertControllerWithTitle:@"Warning" message:@"Warning - your response has be filtered by our automated system and has been recorded. Please refrain from using words that may be viewed as obscene." preferredStyle:UIAlertControllerStyleAlert];
//                    
//                    UIAlertAction* action_ok = [UIAlertAction
//                                                    actionWithTitle:@"Ok"
//                                                    style:UIAlertActionStyleDefault
//                                                    handler:^(UIAlertAction * action)
//                                                    {
//                                                        //Do some thing here
//                                                        [_alertView dismissViewControllerAnimated:YES completion:nil];
//                                                        
//                                                    }];
//                    
//                    [_alertView addAction:action_ok];
//                    
//                    [self presentViewController:_alertView animated:YES completion:nil];
//
//                }
            }
            
            [self sendMessage:msg];
            
        }else{
            [SVProgressHUD showErrorWithStatus:WEB_FAILED];
        }
        
    } failure:^(AFHTTPRequestOperation *operation, NSError *error) {
        
        NSLog(@"%@",operation.responseString);
        [SVProgressHUD showErrorWithStatus:WEB_FAILED];
    }];
}

- (void)messageInputViewDidSelectMediaButton:(SOMessageInputView *)inputView
{
    // Take a photo/video or choose from gallery
}

-(IBAction)onCommunity:(id)sender{
    CommunityVC *mCommunityVC = [theAppDelegate.gMainStoryboard instantiateViewControllerWithIdentifier:@"CommunityVC"];
    [self.navigationController pushViewController:mCommunityVC animated:YES];
//    [self postWithText:5];
}
#pragma mark - logout
-(void)onLogout{
    
    UIAlertController *_alertView = [UIAlertController alertControllerWithTitle:nil message:@"You want to logout?" preferredStyle:UIAlertControllerStyleAlert];
    
    UIAlertAction* logout_cancel = [UIAlertAction
                         actionWithTitle:@"Cancel"
                         style:UIAlertActionStyleDefault
                         handler:^(UIAlertAction * action)
                         {
                             //Do some thing here
                             [_alertView dismissViewControllerAnimated:YES completion:nil];
                             
                         }];
    
    [_alertView addAction:logout_cancel];
    
    UIAlertAction* logout_yes = [UIAlertAction
                                    actionWithTitle:@"Yes"
                                    style:UIAlertActionStyleDefault
                                    handler:^(UIAlertAction * action)
                                    {
                                        //Do some thing here
                                        [STANDARD_DEFAULT_STRING setInteger:0 forKey:@"stock_login"];
                                        [STANDARD_DEFAULT_STRING synchronize];
                                        
                                        [theAppDelegate switchRootViewController:login_check_false];
                                        
                                    }];
    
    [_alertView addAction:logout_yes];
    
    
    [self presentViewController:_alertView animated:YES completion:nil];
    
}


#pragma mark - delegate to uialertview
-(void)alertView:(UIAlertView *)alertView clickedButtonAtIndex:(NSInteger)buttonIndex{
    if (buttonIndex == 1) {
        
        [STANDARD_DEFAULT_STRING setInteger:0 forKey:@"stock_login"];
        [STANDARD_DEFAULT_STRING synchronize];
        
        [theAppDelegate switchRootViewController:login_check_false];
        
    }
}

-(void)activeApp{
    [self loadMessages];
}
- (void)pushReceived:(NSNotification *)notification {

    NSDictionary *userInfo = [notification userInfo];
    Message *chatData = [[Message alloc]init];
    
    if ([userInfo objectForKey:@"question_id"] != nil) {
        chatData.msg_id = [[userInfo objectForKey:@"question_id"] intValue];
    }
    
    if ([userInfo objectForKey:@"answer_text"] != nil) {
        chatData.text = [userInfo objectForKey:@"answer_text"];
    }
    
    chatData.date = [NSDate date];
    
    chatData.type = SOMessageTypeText;
    chatData.fromMe = NO;
    
    int nFlag = 0;
    for (int i=0; i<[self.dataSource count]; i++) {
        Message *mData = [self.dataSource objectAtIndex:i];
        if (mData.msg_id == chatData.msg_id) {
            nFlag = 1;
            break;
        }
    }
    if (nFlag == 0) {
        
        
        
        [self.dataSource addObject:chatData];
        
        [self refreshMessages];
    }
    
//    [self loadMessages];
}
-(IBAction)onStar:(id)sender{
    
    UIButton *btn = (UIButton*)sender;
    
    if (btn == btnStar1) {
        
        btnStar1.tag = 1;
        btnStar2.tag = 0;
        btnStar3.tag = 0;
        btnStar4.tag = 0;
        btnStar5.tag = 0;
        
    }else if (btn == btnStar2){
        
        btnStar1.tag = 1;
        btnStar2.tag = 1;
        btnStar3.tag = 0;
        btnStar4.tag = 0;
        btnStar5.tag = 0;
        
    }else if (btn == btnStar3){
        
        btnStar1.tag = 1;
        btnStar2.tag = 1;
        btnStar3.tag = 1;
        btnStar4.tag = 0;
        btnStar5.tag = 0;
        
    }else if (btn == btnStar4){
        
        btnStar1.tag = 1;
        btnStar2.tag = 1;
        btnStar3.tag = 1;
        btnStar4.tag = 1;
        btnStar5.tag = 0;
        
    }else if (btn == btnStar5){
        
        btnStar1.tag = 1;
        btnStar2.tag = 1;
        btnStar3.tag = 1;
        btnStar4.tag = 1;
        btnStar5.tag = 1;
        
    }
    
    [self onUpdateStarUI];
}

-(void)onUpdateStarUI{
    
    if (btnStar1.tag == 0) {
        [btnStar1 setImage:[UIImage imageNamed:@"unstar"] forState:UIControlStateNormal];
    }else{
        [btnStar1 setImage:[UIImage imageNamed:@"star"] forState:UIControlStateNormal];
    }
    
    if (btnStar2.tag == 0) {
        [btnStar2 setImage:[UIImage imageNamed:@"unstar"] forState:UIControlStateNormal];
    }else{
        [btnStar2 setImage:[UIImage imageNamed:@"star"] forState:UIControlStateNormal];
    }
    
    if (btnStar3.tag == 0) {
        [btnStar3 setImage:[UIImage imageNamed:@"unstar"] forState:UIControlStateNormal];
    }else{
        [btnStar3 setImage:[UIImage imageNamed:@"star"] forState:UIControlStateNormal];
    }
    
    if (btnStar4.tag == 0) {
        [btnStar4 setImage:[UIImage imageNamed:@"unstar"] forState:UIControlStateNormal];
    }else{
        [btnStar4 setImage:[UIImage imageNamed:@"star"] forState:UIControlStateNormal];
    }
    
    if (btnStar5.tag == 0) {
        [btnStar5 setImage:[UIImage imageNamed:@"unstar"] forState:UIControlStateNormal];
    }else{
        [btnStar5 setImage:[UIImage imageNamed:@"star"] forState:UIControlStateNormal];
    }
    
}
-(int)getRating{
    
    int nRating = 0;
    
    if (btnStar1.tag == 1) {
        nRating++;
    }
    
    if (btnStar2.tag == 1) {
        nRating++;
    }
    
    if (btnStar3.tag == 1) {
        nRating++;
    }
    
    if (btnStar4.tag == 1) {
        nRating++;
    }
    
    if (btnStar5.tag == 1) {
        nRating++;
    }
    
    return nRating;
}
-(IBAction)onSubmit:(id)sender{
    
    if (![self onCheckRatingPage]) {
        
        [SVProgressHUD showErrorWithStatus:@"There is no question/answer to rate"];
        
    }else{
        int nRating = [self getRating];
        if (nRating == 0) {
            [SVProgressHUD showErrorWithStatus:@"You can give star 1~5"];
        }else{
            [SVProgressHUD showWithStatus:REQUEST_WAITING];
            
            NSString *urlString = [NSString stringWithFormat:@"%@%@",WEBSERVICE_URL,[NSString stringWithFormat:WEB_RATING_POST]];
            
            AFHTTPRequestOperationManager *manager = [AFHTTPRequestOperationManager manager];
            
            if (theAppDelegate.uDeviceToken == nil) {
                theAppDelegate.uDeviceToken = @"d6cdb99035f272c8a7bb774a2cdc8319e73a4c54caacf50bb0c0b84161f3c48c";
            }
            
            NSDictionary *paramterDic = @{@"question_id":[NSNumber numberWithInt:_mSelectedRatingQuestionMessage.msg_id],
                                          @"answer_id":[NSNumber numberWithInt:_mSelectedRatingAnswerMessage.msg_id],
                                          @"user_id":_mSelectedRatingAnswerMessage.msg_user_id,
                                          @"rating":[NSNumber numberWithInt:[self getRating]],
                                          @"user_own_id":theAppDelegate.gUserData.user_id};
            
            [manager POST:urlString parameters:paramterDic success:^(AFHTTPRequestOperation *operation, id responseObject) {
                
                if ( [responseObject count] > 0 ) {
                    
                    NSDictionary *responseDic = [responseObject objectAtIndex:0];
                    if ([[responseDic objectForKey:@"status"] intValue] == 200) {
                        
                        if ([responseDic objectForKey:@"answer_id"] != nil) {
                            theAppDelegate.gUserData.user_last_rating_qID = [[responseDic objectForKey:@"answer_id"] intValue];
                        }
                        
                        [[Utility getInstance]saveUserData:theAppDelegate.gUserData];
                        
                        if (_mMessageData != nil) {
                            [self onRating:_mMessageData];
                        }else{
                            [SVProgressHUD dismiss];
                        }
                        
                        [UIView animateWithDuration:0.4
                                              delay:0
                                            options:(UIViewAnimationOptionAllowUserInteraction|
                                                     UIViewAnimationOptionBeginFromCurrentState)
                                         animations:^(void) {
                                             rating_y.constant = rating_hide;
                                             [self.view layoutIfNeeded];
                                         }
                                         completion:^(BOOL finished) {
                                             self.tableView.userInteractionEnabled = YES;
                                         }];
                        
                    }else{
                        [SVProgressHUD showErrorWithStatus:WEB_FAILED];
                    }
                    
                    if (swtShare.isOn && shareView.hidden == NO) {
                        
//                        NSString *strShareText = [NSString stringWithFormat:@"%@ - This answer was rated %d Stars with HummingBird(www.hummb.com)\n%@\n\nAnswer: %@" , theAppDelegate.gUserData.user_name , nRating , _mSelectedRatingQuestionMessage.text , _mSelectedRatingAnswerMessage.text];
                        
                        [self postWithText:nRating];
                    }
                }else{
                    [SVProgressHUD showErrorWithStatus:WEB_FAILED];
                }
                
            } failure:^(AFHTTPRequestOperation *operation, NSError *error) {
                
                NSLog(@"%@",operation.responseString);
                [SVProgressHUD showErrorWithStatus:WEB_FAILED];
                
                
            }];
        }
    }
    
    
}

-(IBAction)onSetting:(id)sender{
    
    SettingVC *mSettingVC = [theAppDelegate.gMainStoryboard instantiateViewControllerWithIdentifier:@"SettingVC"];
//    [self.navigationController pushViewController:mSettingVC animated:NO];
    CATransition *transition = [CATransition animation];
    transition.duration = .2;
    transition.type = kCATransitionMoveIn;
    transition.subtype= kCATransitionFromLeft;
    
    [self.navigationController.view.layer addAnimation:transition forKey:kCATransition];
    
    
    [self.navigationController pushViewController:mSettingVC animated:NO];
    
}

-(UIImage*) drawText:(NSString*) text
             inImage:(UIImage*)  image
             imgRect:(CGRect)    imgRect
             txtRect:(CGRect)    txtRect
                view: (UIView*)  view
{
    
    UIFont *font = [UIFont boldSystemFontOfSize:12];
    UIGraphicsBeginImageContext(view.frame.size);
    [image drawInRect:imgRect];
    [[UIColor blackColor] set];
    NSDictionary *attributes = @{ NSFontAttributeName: font};
    [text drawInRect:txtRect withAttributes:attributes];
    UIImage *newImage = UIGraphicsGetImageFromCurrentImageContext();
    UIGraphicsEndImageContext();
    
    return newImage;
}
-(void)postWithText:(int)nRating{
// 
//    FBSDKGraphRequest *request = [[FBSDKGraphRequest alloc]initWithGraphPath:@"/me/feed" parameters:@{@"message":message} tokenString:theAppDelegate.gUserData.user_fb_token version:nil HTTPMethod:@"POST"];
//    
//    
//    [request startWithCompletionHandler:^(FBSDKGraphRequestConnection *connection, id result, NSError *error) {
//        
//        NSLog(@"123");
//    }];
    
    if([SLComposeViewController isAvailableForServiceType:SLServiceTypeFacebook]) {
        
        NSString *title = [NSString stringWithFormat:@"This answer was rated %d Stars with HummingBird(www.hummb.com)\n\nQuestion: %@\n\nAnswer: %@" ,  nRating , _mSelectedRatingQuestionMessage.text , _mSelectedRatingAnswerMessage.text];
//        NSString *title = [NSString stringWithFormat:@"John - This answer was rated 4 Stars with HummingBird(www.hummb.com)\n\nQuestion\n\nAnswer: Answer Test"];
        
        UIImage *imgIcon = [UIImage imageNamed:@"logo.jpg"];
        CGRect imgRect = CGRectMake(0, 0, 93, 93);
//        CGRect txtRect = CGRectMake(100, 10, 500, 85);
        //for (NSNumber *n in @[@(12.0f), @(14.0f), @(18.0f)]) {
        NSNumber *n = @16.0;
        CGFloat fontSize = [n floatValue];
        CGRect r = [title boundingRectWithSize:CGSizeMake(500, 0)
                                   options:NSStringDrawingUsesLineFragmentOrigin
                                attributes:@{NSFontAttributeName:[UIFont systemFontOfSize:fontSize]}
                                   context:nil];
        NSLog(@"fontSize = %f\tbounds = (%f x %f)",
              fontSize,
              r.size.width,
              r.size.height);
        CGRect txtRect = CGRectMake(100, 10, 500, r.size.height);
        
        CGRect viewRect = CGRectMake(0,0,600, r.size.height + 5);
        UIView *myView = [[UIView alloc] initWithFrame:viewRect];
        
        UIImage* imgResult = [self drawText:title inImage:imgIcon imgRect:imgRect txtRect:txtRect view:myView];
        
        SLComposeViewController *controller = [SLComposeViewController composeViewControllerForServiceType:SLServiceTypeFacebook];
        [controller addImage:imgResult];
        [self presentViewController:controller animated:YES completion:Nil];
    }
    
//    FBSDKShareDialog *dialog = [[FBSDKShareDialog alloc] init];
//    dialog.fromViewController = self;
//    dialog.content = content;
//    dialog.mode = FBSDKShareDialogModeShareSheet;
//    [dialog show];
    
}

-(void)testRequest{
    //AIzaSyA3eHOy8wVh-mYGwgpVezPBedltc1zGgo4
    NSString *urlString = [NSString stringWithFormat:@"https://www.googleapis.com/customsearch/v1?q=Christmas&key=AIzaSyA3eHOy8wVh-mYGwgpVezPBedltc1zGgo4"];
    
    AFHTTPRequestOperationManager *manager = [AFHTTPRequestOperationManager manager];
    
    [manager GET:urlString parameters:@{} success:^(AFHTTPRequestOperation *operation, id responseObject) {
        
        if ( [responseObject count] > 0 ) {
            
        }
        
    } failure:^(AFHTTPRequestOperation *operation, NSError *error) {
        
        NSLog(@"%@",operation.responseString);
    }];
}

-(IBAction)onInfo:(id)sender{
    
//    NSString *strMessage = @"Hummingbird is a search application that gives you simple, precise answers to the questions that you might have.\n\n-Where can I get the best fish in town? (requires location)\n-What is the best recipe for chocolate cake?\n-What is the cheapest fare to JFK from NYC?\n-What is El Nino?\n\nIt also lets you answer other users questions in the community section where you can earn credit, get your own answer rated!\n\nAsk us anything!";
    
    NSString *strMessage = @"Hummingbird is a question/answering application that gives you simple, precise answers for the questions you have.\n\n-Where can I get the best fish in town? (requires location)\n-What is the best recipe for chocolate cake?\n-What is the cheapest fare to JFK from NYC?\n-What is El Nino?\n\nHummingbird also lets you answer other user's questions in the 'community' section where you can earn credit, and get your answers rated!\n\nAsk us anything!";

    [lblInfo setText:strMessage];

    [lblInfo sizeToFit];
//
//    UIAlertController *_alertView = [UIAlertController alertControllerWithTitle:strMessage message:nil preferredStyle:UIAlertControllerStyleAlert];
//
//    UIAlertAction *okAction = [UIAlertAction
//                                   actionWithTitle:@"Ok"
//                                   style:UIAlertActionStyleDefault
//                                   handler:^(UIAlertAction * action)
//                                   {
//                                       //Do some thing here
//                                       [_alertView dismissViewControllerAnimated:YES completion:nil];
//                                       
//                                   }];
//    [_alertView addAction:okAction];
//    
//    [self presentViewController:_alertView animated:YES completion:nil];
    
    if (!infoAlertView) {
        
        UIView *infoView = [[UIView alloc]initWithFrame:CGRectMake(0, 0, 300, lblInfo.frame.size.height + 20)];
        lblInfo.frame = CGRectMake(10, 10, lblInfo.frame.size.width, lblInfo.frame.size.height);
        [infoView addSubview:lblInfo];
        
        infoAlertView = [[CustomIOS7AlertView alloc] init];
        [infoAlertView setContainerView:infoView];
        
        [infoAlertView setButtonTitles:[NSMutableArray arrayWithObjects:@"Ok", nil]];
        [infoAlertView setDelegate:self];
        [infoAlertView setUseMotionEffects:true];
    }
    
    [infoAlertView show];
}
- (void)customIOS7dialogButtonTouchUpInside: (CustomIOS7AlertView *)alertView clickedButtonAtIndex: (NSInteger)buttonIndex
{
    if (buttonIndex == 0) {
        [alertView close];
        
    }
}

- (IBAction)recognize:(id)sender {
    ISSpeechRecognition *recognition = [[ISSpeechRecognition alloc] init];
    [recognition setDelegate:self];
    
    NSError *error;
    
    if(![recognition listenAndRecognizeWithTimeout:10 error:&error]) {
//        [self doSomethingWith:error];
    }
}
- (void)recognition:(ISSpeechRecognition *)speechRecognition didGetRecognitionResult:(ISSpeechRecognitionResult *)result {
    NSLog(@"Method: %@", NSStringFromSelector(_cmd));
    NSLog(@"Result: %@", result.text);
    
    [self.messageInputView.textView setText:result.text];
}

- (void)recognition:(ISSpeechRecognition *)speechRecognition didFailWithError:(NSError *)error {
    NSLog(@"Method: %@", NSStringFromSelector(_cmd));
    NSLog(@"Error: %@", error);
}

- (void)recognitionCancelledByUser:(ISSpeechRecognition *)speechRecognition {
    NSLog(@"Method: %@", NSStringFromSelector(_cmd));
}

- (void)recognitionDidBeginRecording:(ISSpeechRecognition *)speechRecognition {
    NSLog(@"Method: %@", NSStringFromSelector(_cmd));
}

- (void)recognitionDidFinishRecording:(ISSpeechRecognition *)speechRecognition {
    NSLog(@"Method: %@", NSStringFromSelector(_cmd));
}

-(void)speakFromText:(NSString*)strMessage{
    
    AVSpeechUtterance *utterance = [AVSpeechUtterance speechUtteranceWithString:strMessage];
    AVSpeechSynthesizer *synth = [[AVSpeechSynthesizer alloc]init];
    [synth speakUtterance:utterance];
    
}

-(IBAction)onChangeFBShare:(id)sender{
    if (swtShare.isOn) {
        [[NSUserDefaults standardUserDefaults] setInteger:1 forKey:@"FBShareFlag"];
    }else{
        [[NSUserDefaults standardUserDefaults] setInteger:0 forKey:@"FBShareFlag"];
    }
    [[NSUserDefaults standardUserDefaults] synchronize];
}

@end
